'use strict';
/*
	MIT License http://www.opensource.org/licenses/mit-license.php
	Author istarkov@gmail.com
*/
var loaderUtils = require('loader-utils');
var path = require('path');
var traverse = require('traverse');

module.exports = function(content) {
	if(this.cacheable) this.cacheable();
	var query = loaderUtils.parseQuery(this.query);
	var imports = [];
	
	var dir = path.dirname(path.resolve(this.resourcePath));
	
	var self = this;
	Object.keys(query).forEach(function(file_name) {
		var fpath = path.join(dir, file_name);
		
		var include_content = JSON.parse( require("fs").readFileSync(fpath) );
		self.addDependency(fpath);
		var obj =  traverse(include_content);
		obj.paths().forEach(function(path) {
			var val = obj.get(path);
			if(typeof val !== 'object') {
				imports.push('$'+path.join('-') + ' : ' + val);		
			}
		})
	});

	var prefix = imports.join('\n') + '\n\n';
	

	return prefix + content;
};